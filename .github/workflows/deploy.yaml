# =============================================================================
# CI/CD ‚Äì Build de API y Worker ‚Üí GHCR + Deploy por SSH con docker compose
# =============================================================================
name: ci-cd

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_API: ghcr.io/${{ github.repository }}/image-express-api
  IMAGE_WORKER: ghcr.io/${{ github.repository }}/image-processing-worker

jobs:
  # ===========================================================================
  # 1) BUILD & PUSH ‚Äì Publica im√°genes en GHCR (API y Worker)
  # ===========================================================================
  build-and-push:
    name: Build & Push images (GHCR)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üß± Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -------- API --------
      - name: üè∑Ô∏è Meta (API)
        id: meta_api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_API }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short

      - name: üèóÔ∏è Build & Push (API)
        uses: docker/build-push-action@v6
        with:
          context: ./image-express-api
          file: ./image-express-api/Dockerfile
          push: true
          tags: ${{ steps.meta_api.outputs.tags }}
          labels: ${{ steps.meta_api.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -------- Worker --------
      - name: üè∑Ô∏è Meta (Worker)
        id: meta_worker
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_WORKER }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short

      - name: üèóÔ∏è Build & Push (Worker)
        uses: docker/build-push-action@v6
        with:
          context: ./image-processing-worker
          file: ./image-processing-worker/Dockerfile
          push: true
          tags: ${{ steps.meta_worker.outputs.tags }}
          labels: ${{ steps.meta_worker.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # 2) DEPLOY ‚Äì Copia archivos al VPS y levanta con compose (override prod)
  # ===========================================================================
  deploy:
    name: Deploy to VPS (docker compose)
    needs: build-and-push
    runs-on: ubuntu-latest
    concurrency: deploy-${{ github.ref }}
    steps:
      - name: üì¶ Copiar archivos (SCP)
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          # host_fingerprint: ${{ secrets.SSH_HOST_FINGERPRINT }}
          source: |
            docker-compose.yml
            deploy/docker-compose.prod.yml
            config/**
            data/traefik/acme
          target: ${{ secrets.DEPLOY_PATH }}

      - name: üöÄ Desplegar (SSH)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}
          # host_fingerprint: ${{ secrets.SSH_HOST_FINGERPRINT }}
          script: |
            set -euo pipefail
            cd "${{ secrets.DEPLOY_PATH }}"

            test -f .env || { echo "‚ùå Falta .env en $PWD"; exit 1; }

            if [ ! -d data/traefik/acme ]; then
              echo "‚ö†Ô∏è  No existe data/traefik/acme ‚Äî creando‚Ä¶"
              mkdir -p data/traefik/acme || { echo "‚ùå No pude crear data/traefik/acme"; exit 1; }
            fi
            if [ ! -f data/traefik/acme/acme.json ]; then
              echo "{}" > data/traefik/acme/acme.json || { echo "‚ùå No pude crear acme.json"; exit 1; }
            fi
            chmod 600 data/traefik/acme/acme.json || { echo "‚ùå No pude aplicar chmod 600 a acme.json"; exit 1; }

            SHORT_SHA="$(echo "${{ github.sha }}" | cut -c1-7)"
            if [ "${{ github.ref_name }}" = "main" ]; then IMAGE_TAG=latest; else IMAGE_TAG="$SHORT_SHA"; fi
            export IMAGE_TAG

            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose -f docker-compose.yml -f deploy/docker-compose.prod.yml pull
            docker compose -f docker-compose.yml -f deploy/docker-compose.prod.yml up -d --remove-orphans
            docker image prune -f
