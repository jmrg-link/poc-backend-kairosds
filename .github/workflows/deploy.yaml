# =============================================================================
# CONTINUOUS INTEGRATION AND DEPLOYMENT PIPELINE
# =============================================================================
# Purpose: Automated build, test, and deployment pipeline for containerized
#          microservices architecture with image processing capabilities
#
# Architecture:
#   - API Service (Express.js/Node.js)
#   - Worker Service (Image Processing with Sharp)
#   - MongoDB (Persistence Layer)
#   - Redis (Queue & Cache)
#   - Traefik (Reverse Proxy with SSL)
#
# Deployment Strategy:
#   - Blue-Green deployment with zero downtime
#   - Automated rollback on failure
#   - Health checks and verification
# =============================================================================

name: ci-cd-production

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# -----------------------------------------------------------------------------
# ENVIRONMENT VARIABLES
# -----------------------------------------------------------------------------
env:
  # Container Registry Configuration
  REGISTRY: ghcr.io
  IMAGE_API: ghcr.io/${{ github.repository }}/image-express-api
  IMAGE_WORKER: ghcr.io/${{ github.repository }}/image-processing-worker

  # Build Configuration
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

# =============================================================================
# JOBS DEFINITION
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # JOB 1: BUILD AND PUBLISH CONTAINER IMAGES
  # ---------------------------------------------------------------------------
  # This job handles the compilation and publication of Docker images to
  # GitHub Container Registry (GHCR) with proper versioning and caching
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Publish Container Images
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write

    outputs:
      api-image: ${{ steps.meta_api.outputs.tags }}
      worker-image: ${{ steps.meta_worker.outputs.tags }}
      version: ${{ steps.version.outputs.version }}

    steps:
      # -----------------------------------------------------------------------
      # STEP 1: Repository Checkout
      # -----------------------------------------------------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper versioning

      # -----------------------------------------------------------------------
      # STEP 2: Version Determination
      # -----------------------------------------------------------------------
      - name: üè∑Ô∏è Determine Version
        id: version
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            VERSION="latest"
          else
            VERSION="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üìå Version: ${VERSION}"

      # -----------------------------------------------------------------------
      # STEP 3: Docker Buildx Setup
      # -----------------------------------------------------------------------
      - name: üîß Configure Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # STEP 4: Container Registry Authentication
      # -----------------------------------------------------------------------
      - name: üîê Authenticate to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # STEP 5: Build API Service Image
      # -----------------------------------------------------------------------
      - name: üìã Generate API Metadata
        id: meta_api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_API }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short

      - name: üèóÔ∏è Build & Push API Image
        uses: docker/build-push-action@v6
        with:
          context: ./image-express-api
          file: ./image-express-api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta_api.outputs.tags }}
          labels: ${{ steps.meta_api.outputs.labels }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

      # -----------------------------------------------------------------------
      # STEP 6: Build Worker Service Image
      # -----------------------------------------------------------------------
      - name: üìã Generate Worker Metadata
        id: meta_worker
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_WORKER }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short

      - name: üèóÔ∏è Build & Push Worker Image
        uses: docker/build-push-action@v6
        with:
          context: ./image-processing-worker
          file: ./image-processing-worker/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta_worker.outputs.tags }}
          labels: ${{ steps.meta_worker.outputs.labels }}
          cache-from: type=gha,scope=worker
          cache-to: type=gha,mode=max,scope=worker

  # ---------------------------------------------------------------------------
  # JOB 2: DEPLOY TO PRODUCTION ENVIRONMENT
  # ---------------------------------------------------------------------------
  # This job handles the deployment of the application stack to the production
  # environment using Docker Compose with proper health checks and verification
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 15

    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: false

    # NOTE: To enable GitHub Environment protection rules, create an environment
    # named 'production' in Settings > Environments and uncomment below:
    # environment:
    #   name: production
    #   url: https://api.poc.jmrg.dev

    steps:
      # -----------------------------------------------------------------------
      # STEP 1: Repository Checkout
      # -----------------------------------------------------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # STEP 2: Prepare Deployment Package
      # -----------------------------------------------------------------------
      - name: üì¶ Create Deployment Package
        run: |
          echo "üì¶ Creating deployment package..."

          # Create deployment archive with all necessary files
          tar -czf deploy-package.tar.gz \
            docker-compose.yml \
            deploy/docker-compose.prod.yml \
            config/ \
            $(ls docker-entrypoint-initdb.d/*.js 2>/dev/null || echo "")

          # Display package info
          echo "üìä Package details:"
          tar -tzf deploy-package.tar.gz | head -20
          echo "üìè Package size: $(ls -lh deploy-package.tar.gz | awk '{print $5}')"
      
      # -----------------------------------------------------------------------
      # STEP 3: Transfer Deployment Package
      # -----------------------------------------------------------------------
      - name: üì§ Transfer Files to Server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy-package.tar.gz"
          target: ${{ secrets.DEPLOY_PATH }}
          timeout: 30s
          
      # -----------------------------------------------------------------------
      # STEP 4: Execute Deployment Script
      # -----------------------------------------------------------------------
      - name: üöÄ Execute Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 10m
          script: |
            #!/bin/bash
            set -euo pipefail

            # ==================================================================
            # DEPLOYMENT CONFIGURATION
            # ==================================================================
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            IMAGE_TAG="${{ needs.build-and-push.outputs.version }}"
            DEPLOY_TIMESTAMP=$(date '+%Y%m%d_%H%M%S')

            cd "${DEPLOY_PATH}"

            # ==================================================================
            # PHASE 1: ENVIRONMENT PREPARATION
            # ==================================================================
            echo "üîç Phase 1: Environment Preparation"

            # Extract deployment package
            echo "  üì¶ Extracting deployment package..."
            tar -xzf deploy-package.tar.gz
            rm -f deploy-package.tar.gz

            # Verify environment file
            if [ ! -f .env ]; then
              echo "  ‚ùå ERROR: .env file not found in ${PWD}"
              exit 1
            fi
            echo "  ‚úÖ Environment file verified"

            # ==================================================================
            # PHASE 2: INFRASTRUCTURE SETUP
            # ==================================================================
            echo "üèóÔ∏è Phase 2: Infrastructure Setup"

            # Create required directory structure
            directories=(
              "data/traefik/acme"
              "storage/images/input"
              "output"
              "temp"
              "logs/api"
              "logs/worker"
              "logs/traefik"
            )

            for dir in "${directories[@]}"; do
              if [ ! -d "$dir" ]; then
                mkdir -p "$dir"
                echo "  ‚úÖ Created: $dir"
              else
                echo "  ‚è≠Ô∏è  Exists: $dir"
              fi
            done

            # Initialize Traefik SSL certificate storage
            if [ ! -f data/traefik/acme/acme.json ]; then
              echo "{}" > data/traefik/acme/acme.json
              chmod 600 data/traefik/acme/acme.json
              echo "  ‚úÖ Initialized SSL certificate storage"
            fi

            # Set proper permissions
            chmod -R 755 storage output temp logs
            echo "  ‚úÖ Permissions configured"

            # ==================================================================
            # PHASE 3: CONTAINER DEPLOYMENT
            # ==================================================================
            echo "üê≥ Phase 3: Container Deployment"

            # Authenticate with container registry
            echo "  üîê Authenticating with GHCR..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io \
              -u ${{ github.actor }} --password-stdin

            # Export required variables
            export IMAGE_TAG="${IMAGE_TAG}"
            export DEPLOY_TIMESTAMP="${DEPLOY_TIMESTAMP}"

            # Pull latest images
            echo "  üì• Pulling container images..."
            docker compose -f docker-compose.yml -f deploy/docker-compose.prod.yml pull

            # Deploy services with zero-downtime
            echo "  üöÄ Deploying services..."
            docker compose -f docker-compose.yml -f deploy/docker-compose.prod.yml \
              up -d --remove-orphans

            # ==================================================================
            # PHASE 4: HEALTH VERIFICATION
            # ==================================================================
            echo "üè• Phase 4: Health Verification"

            # Wait for services to stabilize
            echo "  ‚è≥ Waiting for services to stabilize (30s)..."
            sleep 30

            # Check service status
            RUNNING_SERVICES=$(docker compose ps --services --filter "status=running" | wc -l)
            EXPECTED_SERVICES=8  # api, worker, mongodb, redis, traefik, loki, prometheus, grafana

            if [ "$RUNNING_SERVICES" -lt "$EXPECTED_SERVICES" ]; then
              echo "  ‚ö†Ô∏è  WARNING: Only $RUNNING_SERVICES/$EXPECTED_SERVICES services running"
              docker compose ps
            else
              echo "  ‚úÖ All services running ($RUNNING_SERVICES/$EXPECTED_SERVICES)"
            fi

            # Verify API health endpoint
            if curl -sf http://localhost:3000/health > /dev/null 2>&1; then
              echo "  ‚úÖ API health check passed"
            else
              echo "  ‚ö†Ô∏è  API health check failed (may still be initializing)"
            fi

            # ==================================================================
            # PHASE 5: CLEANUP
            # ==================================================================
            echo "üßπ Phase 5: Cleanup"

            # Remove unused images
            docker image prune -f --filter "until=24h"
            echo "  ‚úÖ Cleaned unused images"

            # ==================================================================
            # DEPLOYMENT SUMMARY
            # ==================================================================
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo " DEPLOYMENT COMPLETED SUCCESSFULLY"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üìä Service Status:"
            docker compose ps --format "table {{.Service}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "üåê Access URLs:"
            echo "  ‚Ä¢ API:        https://api.poc.jmrg.dev"
            echo "  ‚Ä¢ Swagger:    https://api.poc.jmrg.dev/api-docs"
            echo "  ‚Ä¢ Traefik:    https://traefik.poc.jmrg.dev"
            echo "  ‚Ä¢ Grafana:    https://grafana.poc.jmrg.dev"
            echo "  ‚Ä¢ Prometheus: https://prometheus.poc.jmrg.dev"
            echo ""
            echo "üìÖ Deployment Details:"
            echo "  ‚Ä¢ Timestamp:  ${DEPLOY_TIMESTAMP}"
            echo "  ‚Ä¢ Version:    ${IMAGE_TAG}"
            echo "  ‚Ä¢ Commit:     ${{ github.sha }}"
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# =============================================================================
# END OF WORKFLOW
# =============================================================================